<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>صحيح البخاري - نسخة محسنة</title>
    <!-- استدعاء Tailwind CSS من CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- استدعاء خطوط Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Tajawal', sans-serif;
        }
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        /* تعريف فئة التمييز باللون الأحمر لكلمات البحث */
        .highlight {
            color: #ef4444; /* red-500 */
            font-weight: 700;
        }
        /* فئة جديدة للون البني المصفر لاسم الراوي */
        .narrator-color {
            color: #A0522D; /* Sienna - بني مصفر */
            font-weight: 600; /* جعل النص أكثر وضوحًا */
        }
        .arabic-hadith-font {
            font-family: 'Amiri', serif;
        }
        /* مؤشر التحميل عند التمرير */
        #infinite-loader.hidden {
            display: none;
        }
        /* Style for the copy message */
        .copy-message {
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            position: absolute; /* Added for correct positioning relative to parent */
            bottom: 8px; /* Adjusted position */
            left: 50px; /* Adjusted position, will be right in RTL */
            background-color: rgba(0, 128, 0, 0.8); /* Green background */
            color: white;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            white-space: nowrap; /* Prevent wrapping */
            z-index: 10; /* Ensure it's above other elements */
        }
        .copy-message.show {
            opacity: 1;
        }
        /* Progress bar styles */
        #progress-container {
            width: 80%;
            background-color: #e0e0e0;
            border-radius: 5px;
            height: 20px;
            margin: 10px auto;
            overflow: hidden;
        }
        #progress-bar {
            width: 0%;
            height: 100%;
            background-color: #2563eb; /* blue-600 */
            border-radius: 5px;
            text-align: center;
            color: white;
            line-height: 20px;
            font-size: 0.8rem;
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- حاوية التطبيق الرئيسية -->
    <div class="container mx-auto p-4 md:p-6 lg:p-8">

        <!-- رأس الصفحة -->
        <header class="text-center mb-6">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-700">صحيح البخاري</h1>
            <p class="text-gray-500 mt-2">تصفح وابحث في أحاديث الرسول صلى الله عليه وسلم</p>
        </header>

        <!-- قسم البحث -->
        <div class="mb-6 sticky top-0 bg-gray-100 py-4 z-10 shadow-sm">
            <div class="flex items-center space-x-2 rtl:space-x-reverse">
                <input type="text" id="searchInput"
                    class="flex-grow p-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-blue-500 transition-colors"
                    placeholder="ابحث عن حديث...">
                <button id="searchButton"
                    class="bg-blue-500 text-white p-3 rounded-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-colors flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                    <span class="mr-2 hidden md:inline">بحث</span>
                </button>
            </div>
            <div id="search-info" class="text-center text-gray-500 mt-2 text-sm"></div>
        </div>
        
        <!-- قسم عرض الأحاديث -->
        <main id="hadiths-container" class="space-y-4">
            <!-- سيتم عرض الأحاديث هنا -->
        </main>

        <!-- مؤشر التحميل الأولي مع شريط التقدم -->
        <div id="initial-loader" class="text-center py-10">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500 mx-auto"></div>
            <p class="mt-4 text-gray-600">جارٍ تحميل الأحاديث...</p>
            <div id="progress-container">
                <div id="progress-bar">0%</div>
            </div>
        </div>
        
        <!-- مؤشر التحميل عند التمرير -->
        <div id="infinite-loader" class="hidden text-center py-10">
             <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto"></div>
        </div>


        <!-- زر العودة إلى الأعلى -->
        <button id="back-to-top" class="hidden fixed bottom-5 right-5 bg-blue-500 text-white p-3 rounded-full shadow-lg hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 transition-transform transform hover:scale-110">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
            </svg>
        </button>

    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const hadithsContainer = document.getElementById('hadiths-container');
            const searchInput = document.getElementById('searchInput');
            const searchButton = document.getElementById('searchButton'); 
            const searchInfo = document.getElementById('search-info');
            const initialLoader = document.getElementById('initial-loader');
            const infiniteLoader = document.getElementById('infinite-loader');
            const backToTopBtn = document.getElementById('back-to-top');
            const progressBar = document.getElementById('progress-bar');

            // --- State Management ---
            let allHadiths = []; // Stores all hadiths after fetch
            let currentHadiths = []; // Stores currently displayed hadiths (can be all or filtered)
            let chapterMap = new Map();
            let displayCount = 0; // How many hadiths are currently rendered
            const HADITHS_PER_PAGE = 50; // Number of hadiths to load at a time
            let isFetching = false; // Flag to prevent multiple fetches

            // --- Normalization and Regex Functions ---
            // هذه الدالة تستخدم لتوحيد النص عند البحث فقط (للمطابقة الدقيقة في الفلترة)
            // تزيل الحركات وتوحد بعض الحروف المتشابهة لزيادة فعالية البحث
            function normalizeArabicForSearch(text) {
                if (!text) return '';
                // إزالة علامات التشكيل (الحركات)
                text = text.replace(/[\u064B-\u0652]/g, ""); 
                // توحيد الألفات (أ, إ, آ) إلى ألف عادية
                text = text.replace(/[أإآ]/g, "ا"); 
                // توحيد التاء المربوطة (ة) إلى هاء (ه)
                text = text.replace(/ة/g, "ه");
                // توحيد الألف المقصورة (ى) إلى ياء (ي)
                text = text.replace(/ى/g, "ي");
                return text;
            }

            // هذه الدالة تنشئ تعبيرًا عاديًا مرنًا للتمييز (highlighting)
            // هدفها هو مطابقة كلمة البحث في النص الأصلي بغض النظر عن الحركات أو بعض اختلافات الحروف
            function createArabicHighlightRegex(searchTerm) {
                if (!searchTerm) return null;

                let pattern = '';
                // قم بتنظيف كلمة البحث من الحركات قبل بناء النمط
                // هذا لضمان أن النمط نفسه لا يتأثر بأي تشكيل في كلمة البحث المدخلة
                const cleanedSearchTerm = searchTerm.replace(/[\u064B-\u0652]/g, ""); 

                // نمر على كل حرف في كلمة البحث "المنظفة"
                for (let i = 0; i < cleanedSearchTerm.length; i++) {
                    let char = cleanedSearchTerm[i];
                    let regexChar = '';

                    // تحديد الأشكال المختلفة المحتملة لكل حرف عربي
                    switch(char) {
                        case 'ا': regexChar = '[اأإآ]'; break; // يطابق الألف بأي من أشكال الهمزة عليها
                        case 'ة': regexChar = '[ةه]'; break;    // يطابق التاء المربوطة أو الهاء
                        case 'ي': regexChar = '[ىي]'; break;    // يطابق الياء أو الألف المقصورة
                        case 'ء': regexChar = '[ءئؤ]'; break;  // يطابق الهمزة المنفصلة أو على الياء أو على الواو
                        // أي حرف خاص في التعبير العادي يجب الهروب منه (مثل النقطة، النجمة، إلخ)
                        case '.': case '*': case '+': case '?': case '(': case ')':
                        case '[': case ']': case '}': case '\\': case '|':
                        case '^': case '$':
                            regexChar = '\\' + char; break;
                        default: regexChar = char; // لأي حرف آخر، يطابقه حرفيًا
                    }
                    // إضافة `[\\u064B-\\u0652]*` لجعل علامات التشكيل اختيارية (صفر أو أكثر) بعد كل حرف أساسي
                    // هذا يضمن أن التمييز يعمل سواء كانت الكلمة مشكلة أم لا في الحديث الأصلي
                    pattern += regexChar + '[\\u064B-\\u0652]*';
                }
                // إنشاء التعبير العادي: 'g' لكل المطابقات، 'i' لتجاهل حالة الأحرف (مفيد للإنجليزية، ولكنه لا يضر هنا)
                return new RegExp(pattern, 'gi'); 
            }
            
            // --- Data Fetching and Initialization ---
            async function loadData() {
                try {
                    // تم التعديل لتحميل الملف المحلي من مجلد المشروع
                    const response = await fetch('bukhari.json');
                    if (!response.ok) throw new Error('Network response was not ok');
                    
                    const reader = response.body.getReader();
                    const contentLength = +response.headers.get('Content-Length');
                    let receivedLength = 0;
                    let chunks = [];

                    // Loop to read the stream and update progress
                    while (true) {
                        const { done, value } = await reader.read();
                        if (done) {
                            break;
                        }
                        chunks.push(value);
                        receivedLength += value.length;
                        
                        // Calculate and update progress
                        const progress = Math.round((receivedLength / contentLength) * 100);
                        progressBar.style.width = `${progress}%`;
                        progressBar.textContent = `${progress}%`;
                    }

                    // Concatenate chunks and parse JSON
                    let hadithText = '';
                    for (let i = 0; i < chunks.length; i++) {
                        hadithText += new TextDecoder('utf-8').decode(chunks[i], {stream: i < chunks.length -1});
                    }
                    const data = JSON.parse(hadithText);
                    
                    // Pre-process and normalize data once on load
                    // نستخدم normalizedArabic هنا للبحث فقط في مصفوفة allHadiths، وليس للعرض
                    allHadiths = data.hadiths.map(h => ({
                        ...h,
                        originalArabic: h.arabic, // حفظ النص الأصلي للتمييز
                        normalizedArabic: normalizeArabicForSearch(h.arabic) // نسخة موحدة للبحث
                    }));
                    
                    data.chapters.forEach(chapter => {
                        chapterMap.set(chapter.id, { arabic: chapter.arabic });
                    });
                    
                    currentHadiths = allHadiths;
                    initialLoader.classList.add('hidden');
                    resetAndDisplayHadiths();

                } catch (error) {
                    console.error('Error fetching data:', error);
                    initialLoader.innerHTML = `<p class="text-red-500">حدث خطأ أثناء تحميل البيانات. تأكد من وجود ملف 'bukhari.json' في نفس المجلد، أو جرب تشغيل المشروع باستخدام 'Live Server'.</p>`;
                }
            }

            // --- Rendering Logic ---
            function renderHadiths(startIndex, hadithsToRender) {
                isFetching = true;
                infiniteLoader.classList.remove('hidden');

                // دالة جديدة لاستخراج سلسلة الرواة من نص الحديث
                function getNarratorChain(hadithText) {
                    const hadithStartPhrases = [
                        'قال رسول الله صلى الله عليه وسلم',
                        'قال رسول الله',
                        'عن النبي صلى الله عليه وسلم',
                        'عن النبي',
                        'فقال رسول الله',
                        'أن رسول الله'
                    ];

                    for (const phrase of hadithStartPhrases) {
                        const index = hadithText.indexOf(phrase);
                        // إذا وجدنا عبارة تدل على بداية الحديث، والجزء الذي يسبقها ليس فارغاً (لتجنب الحالات التي تبدأ فيها العبارة من الصفر)
                        if (index !== -1 && index > 0) {
                            let chain = hadithText.substring(0, index).trim();
                            // يمكن إضافة منطق لتنظيف السلسلة أو التحقق من صحتها هنا
                            return chain;
                        }
                    }
                    return ''; // لم يتم العثور على سلسلة رواة واضحة
                }

                requestAnimationFrame(() => {
                    const fragment = document.createDocumentFragment();
                    const endIndex = Math.min(startIndex + HADITHS_PER_PAGE, hadithsToRender.length);

                    for (let i = startIndex; i < endIndex; i++) {
                        const hadith = hadithsToRender[i];
                        if (!hadith) continue;
                        
                        const chapterData = chapterMap.get(hadith.chapterId);
                        const chapterName = chapterData ? chapterData.arabic : 'غير معروف'; // Chapter name (not used in rendering due to user request)
                        
                        const hadithCard = document.createElement('div');
                        hadithCard.className = 'hadith-card bg-white p-4 md:p-6 rounded-lg shadow-md transition-shadow hover:shadow-lg relative'; // Added 'relative' for positioning copy message
                        hadithCard.dataset.hadithId = hadith.id; // Add data attribute

                        const searchTerm = searchInput.value.trim();
                        // نستخدم النص الأصلي (hadith.originalArabic) هنا لتمييز كلمات البحث
                        let highlightedText = hadith.originalArabic; 
                        
                        // تمييز كلمة البحث إذا كانت موجودة
                        if(searchTerm) {
                            const highlightRegex = createArabicHighlightRegex(searchTerm);
                            if(highlightRegex) {
                                // استخدام فئة "highlight" لتمييز النص المطابق
                                highlightedText = highlightedText.replace(highlightRegex, `<span class="highlight">$&</span>`);
                            }
                        }

                        // استخراج وعرض سلسلة الرواة في سطر منفصل
                        const narratorChain = getNarratorChain(hadith.originalArabic);
                        
                        hadithCard.innerHTML = `
                            <div class="flex justify-between items-center mb-3 pb-3 border-b">
                                <!-- تم إزالة عرض اسم الفصل (الكتاب) هنا بناءً على طلب المستخدم -->
                                <span class="text-sm font-medium text-gray-500">حديث رقم: ${hadith.id}</span>
                            </div>
                            ${narratorChain ? `<p class="text-md text-gray-700 narrator-color mb-2">${narratorChain}</p>` : ''}
                            <p class="text-lg leading-relaxed arabic-hadith-font mb-4" id="hadith-text-${hadith.id}">${highlightedText}</p>
                            <div class="absolute bottom-2 left-2 flex items-center">
                                <button class="copy-button bg-gray-200 text-gray-700 p-2 rounded-full hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 focus:ring-opacity-50 transition-colors text-sm" data-hadith-id="${hadith.id}" title="نسخ الحديث">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m-4 3H9m10 0h-3m-7 0H4" />
                                    </svg>
                                </button>
                                <span id="copy-message-${hadith.id}" class="copy-message">تم النسخ!</span>
                            </div>
                        `;
                        fragment.appendChild(hadithCard);
                    }

                    hadithsContainer.appendChild(fragment);
                    displayCount = endIndex;
                    
                    // Add event listeners to the new copy buttons
                    document.querySelectorAll('.copy-button').forEach(button => {
                        button.onclick = function() {
                            const hadithId = this.dataset.hadithId;
                            const hadithTextElement = document.getElementById(`hadith-text-${hadithId}`);
                            if (hadithTextElement) {
                                // Remove highlight spans for clean copy
                                const textToCopy = hadithTextElement.innerText || hadithTextElement.textContent;
                                
                                const tempInput = document.createElement('textarea');
                                tempInput.value = textToCopy;
                                document.body.appendChild(tempInput);
                                tempInput.select();
                                document.execCommand('copy');
                                document.body.removeChild(tempInput);

                                // Show confirmation message
                                const messageElement = document.getElementById(`copy-message-${hadithId}`);
                                if (messageElement) {
                                    messageElement.classList.add('show');
                                    // Adjust message position dynamically based on button position if needed
                                    // For simplicity, fixed relative positioning is used in CSS
                                    setTimeout(() => {
                                        messageElement.classList.remove('show');
                                    }, 2000); // Hide after 2 seconds
                                }
                            }
                        };
                    });

                    infiniteLoader.classList.add('hidden');
                    isFetching = false;
                    updateSearchInfo();
                });
            }

            function resetAndDisplayHadiths() {
                displayCount = 0;
                hadithsContainer.innerHTML = '';
                // Scroll to top when resetting and displaying hadiths after a search
                window.scrollTo({ top: 0, behavior: 'smooth' }); 
                renderHadiths(0, currentHadiths);
            }

            function updateSearchInfo() {
                const searchTerm = searchInput.value.trim();
                 if (currentHadiths.length === 0) {
                        hadithsContainer.innerHTML = `<div class="bg-white p-6 rounded-lg shadow-md text-center text-gray-500">لا توجد نتائج تطابق بحثك.</div>`;
                        searchInfo.textContent = 'تم العثور على 0 نتيجة.';
                        return;
                    }

                if (searchTerm) {
                    searchInfo.textContent = `عرض ${displayCount} من ${currentHadiths.length} نتيجة لكلمة "${searchTerm}"`;
                } else {
                    searchInfo.textContent = `عرض ${displayCount} من ${allHadiths.length} حديث`;
                }
            }


            // --- Event Handlers ---
            function executeSearch() {
                const searchTerm = searchInput.value.trim();
                
                if (!searchTerm) {
                    currentHadiths = allHadiths;
                } else {
                    const normalizedSearchTerm = normalizeArabicForSearch(searchTerm);
                    currentHadiths = allHadiths.filter(hadith =>
                        hadith.normalizedArabic.includes(normalizedSearchTerm)
                    );
                }
                resetAndDisplayHadiths(); 
            }

            function handleScroll() {
                if (isFetching || displayCount >= currentHadiths.length) return;
                
                // Check if user is near the bottom of the page
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 500) {
                     renderHadiths(displayCount, currentHadiths);
                }
            }

            // --- Event Listeners ---
            searchButton.addEventListener('click', executeSearch);
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    executeSearch();
                }
            });
             searchInput.addEventListener('input', () => {
                // Trigger search when input is cleared
                if(searchInput.value.trim() === '') {
                    executeSearch();
                }
            });


            window.addEventListener('scroll', handleScroll, { passive: true });

            // Back to top button logic
            window.addEventListener('scroll', () => {
                if (window.pageYOffset > 300) {
                    backToTopBtn.classList.remove('hidden');
                } else {
                    backToTopBtn.classList.add('hidden');
                }
            });

            backToTopBtn.addEventListener('click', () => {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            });

            // --- Initial Load ---
            loadData();
        });
    </script>
</body>
</html>
